name: 🍷 Train Wine Classifier

on:
  workflow_dispatch:
    inputs:
      script_path:
        description: 'Training script to run'
        required: true
        default: 'src/training/train.py'
        type: string
      extra_args:
        description: 'Additional arguments (e.g., --epochs 50 --batch-size 32)'
        required: false
        type: string
      num_cpus:
        description: 'Number of CPUs'
        required: false
        default: '1'
        type: string
      memory:
        description: 'Memory (e.g., 2Gi)'
        required: false
        default: '2Gi'
        type: string
      experiment_name:
        description: 'MLflow experiment name'
        required: false
        default: wine-quality

jobs:
  train:
    name: 🏃 Run Training
    runs-on: self-hosted-local  # Change to ubuntu-latest for production
    steps:
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p ~/.local/bin
          mv kubectl ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          ~/.local/bin/kubectl cluster-info

      - name: Submit Ray Job
        run: |
          cat <<EOF | ~/.local/bin/kubectl apply -f -
          apiVersion: ray.io/v1
          kind: RayJob
          metadata:
            name: ${{ github.event.repository.name }}-${{ github.run_id }}
            namespace: ai
            labels:
              repo: ${{ github.event.repository.name }}
              run-id: "${{ github.run_id }}"
          spec:
            shutdownAfterJobFinishes: true
            ttlSecondsAfterFinished: 300
            rayClusterSpec:
              rayVersion: "2.48.0"
              headGroupSpec:
                serviceType: ClusterIP
                template:
                  spec:
                    containers:
                    - name: ray-head
                      image: opencloudhuborg/wine-classifier-training:latest
                      resources:
                        requests:
                          cpu: "${{ inputs.num_cpus }}"
                          memory: "${{ inputs.memory }}"
                      env:
                      - name: MLFLOW_TRACKING_URI
                        value: http://mlflow.mlops.svc.cluster.local:5000
                      - name: MLFLOW_EXPERIMENT_NAME
                        value: ${{ inputs.experiment_name }}
              workerGroupSpecs:
              - replicas: 1
                groupName: worker
                template:
                  spec:
                    containers:
                    - name: ray-worker
                      image: opencloudhuborg/wine-classifier-training:latest
                      resources:
                        requests:
                          cpu: "${{ inputs.num_cpus }}"
                          memory: "${{ inputs.memory }}"
            entrypoint: python ${{ inputs.script_path }} ${{ inputs.extra_args }}
          EOF
