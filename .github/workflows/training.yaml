name: ü§ñ Train Wine Classifier

on:
  workflow_dispatch:
    inputs:
      script_path:
        description: 'Training script to run'
        required: true
        default: 'src/train.py'
        type: string

      extra_args:
        description: 'Additional arguments (e.g., --epochs 50 --batch-size 32)'
        required: false
        type: string

      ray_resources:
        description: 'Ray resource requirements (JSON)'
        required: false
        default: '{"num_cpus": 1, "memory": "2Gi"}'
        type: string

      experiment_name:
        description: 'MLflow experiment name'
        required: false
        default: ${{ github.event.repository.name }}

env:
  MLFLOW_TRACKING_URI: "http://172.17.0.1:8081"

jobs:
  train:
    name: üèÉ Run Training
    runs-on: self-hosted-local  # Use our runner for local testing

    steps:
      - name: Submit Ray Job
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: ray.io/v1
          kind: RayJob
          metadata:
            name: ${{ github.event.repository.name }}-${{ github.run_id }}
            namespace: ai
            labels:
              repo: ${{ github.event.repository.name }}
              run-id: "${{ github.run_id }}"
          spec:
            # Ephemeral Ray cluster spec
            rayClusterSpec:
              rayVersion: "2.48.0"
              headGroupSpec:
                serviceType: ClusterIP
                template:
                  spec:
                    containers:
                    - name: ray-head
                      image: ghcr.io/opencloudhub/${{ github.event.repository.name }}:${{ github.sha }}
                      resources:
                        requests: ${{ fromJSON(inputs.ray_resources) }}
                      env:
                      - name: MLFLOW_TRACKING_URI
                        value: http://mlflow.mlops.svc.cluster.local:5000
                      - name: MLFLOW_EXPERIMENT_NAME
                        value: ${{ inputs.experiment_name }}
              workerGroupSpecs:
              - replicas: 1
                groupName: worker
                template:
                  spec:
                    containers:
                    - name: ray-worker
                      image: ghcr.io/opencloudhub/${{ github.event.repository.name }}:${{ github.sha }}
                      resources:
                        requests: ${{ fromJSON(inputs.ray_resources) }}
            entrypoint: python ${{ inputs.script_path }} ${{ inputs.extra_args }}
          EOF
