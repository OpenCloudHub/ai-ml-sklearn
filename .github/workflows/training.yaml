name: 🤖 Train Wine Classifier

# This workflow demonstrates MLflow integration with containerized training environments.
# Code is mounted into containers at runtime to avoid rebuilds on every change.
# The training image contains only the Python environment - source code comes from the repo.

on:
  workflow_dispatch:
    inputs:
      mlflow_command:
        description: 'MLflow run command'
        required: true
        default: 'mlflow run . --entry-point training'
        type: string

env:
  MLFLOW_TRACKING_URI: "http://172.17.0.1:8081"
  MLFLOW_EXPERIMENT_NAME: "wine-quality"

jobs:
  train:
    name: 🏃 Run Training
    runs-on: self-hosted  # Use our runner for local testing
    
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python and install MLflow
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: 📦 Install dependencies
        run: |
          pip install uv
          uv sync --dev
      
      - name: 🔐 Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: 🤖 Run MLflow command
        run: |
          source .venv/bin/activate
          ${{ inputs.mlflow_command }}
      
      - name: 📊 Summary
        run: |
          echo "## 🤖 Training Complete!" >> $GITHUB_STEP_SUMMARY
          echo "- **Command**: \`${{ inputs.mlflow_command }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **MLflow UI**: ${{ env.MLFLOW_TRACKING_URI }}" >> $GITHUB_STEP_SUMMARY
